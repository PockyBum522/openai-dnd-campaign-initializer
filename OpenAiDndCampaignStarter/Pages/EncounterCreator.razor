@page "/encounter-creator"

<PageTitle>Encounter Creator</PageTitle>

@using OpenAiDndCampaignStarter.Data.Logic
@using System.Security.Cryptography
@using Humanizer

@inject IOpenAiRequestor OpenAiRequestor;

<h1>5e Encounter Creator</h1>

@if (_encounterAreaDescription == null)
{
    <p>
        <em>Loading...</em>
    </p>
}
else
{
    <br/>
    
    <p>
        <h3>Encounter Area Description:</h3>
        @_encounterAreaDescription
    </p>
    
    <p>
        <h3>Visible Monsters:</h3>
        (@_numberOfMonsters?.FirstCharToUpper() @_monsterType)<br/>
        @_monstersDescription
    </p>
    
    <p>
        <h3>Their Leader:</h3>
        @_monstersLeaderDescription
    </p>
        
    <p>
        <h3>Potential Unexpected Problems:</h3>
        @_enounterProblem
    </p>
    
    <p>
        <h3>Source Material:</h3>
        @_alwaysPluralMonsterType can be found on page @_monsterPage of @_sourceMaterial
    </p>
}

@code {
    private string? _encounterAreaDescription;
    private string? _numberOfMonsters;
    private string? _monsterType;
    private string? _monstersDescription;
    private string? _monstersLeaderDescription;
    private string? _enounterProblem;
    private string? _alwaysPluralMonsterType;
    private string? _monsterPage;
    private string? _sourceMaterial;

    protected override async Task OnInitializedAsync()
    {
        var numberOfMonsters = RandomNumberGenerator.GetInt32(1, 10);

        _numberOfMonsters = numberOfMonsters.ToWords();

        var randomMonster = MonsterTableHelpers.GetRandom5eMonster();

        // Pluralize if there are more than one monsters
        if (numberOfMonsters > 1)
        {
            _monsterType = randomMonster.CreatureName.Pluralize();
        }
        else
        {
            _monsterType = randomMonster.CreatureName;
        }
        
        _alwaysPluralMonsterType = randomMonster.CreatureName.Pluralize();
        _monsterPage = randomMonster.SourcePageNumber.ToString();
        _sourceMaterial = randomMonster.SourceMaterial;

        var encounterAreaTask = OpenAiRequestor.GetTextCompletionAsync(
            "Topic: Description. Please give me a description of an area in the middle of a journey.");

        var encounterMonstersDescriptionTask = OpenAiRequestor.GetTextCompletionAsync(
            $"Topic: Description. Please give me a description of a group of {_numberOfMonsters} {_monsterType} monsters.");
        
        var encounterMonstersLeaderDescriptionTask = OpenAiRequestor.GetTextCompletionAsync(
            $"Topic: Description. Please give me a description of the leader of a group of {_monsterType} monsters.");

        var encounterProblemTask = OpenAiRequestor.GetTextCompletionAsync(
            $"Topic: Medieval battle. Please give me a reason why a battle against {_alwaysPluralMonsterType} might unexpectedly get more difficult.");

        _enounterProblem = await encounterProblemTask;

        _monstersLeaderDescription = await encounterMonstersLeaderDescriptionTask;
        
        _monstersDescription = await encounterMonstersDescriptionTask;

        _encounterAreaDescription = await encounterAreaTask;
    }
}